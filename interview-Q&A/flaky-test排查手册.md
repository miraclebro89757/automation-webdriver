# 常见 Flaky Test 排查手册

## 1. 什么是 Flaky Test？

Flaky Test（偶发失败用例）指的是：同样的测试用例，在相同环境下多次执行，结果有时通过有时失败，表现为“不稳定、不可复现”。

---

## 2. 常见成因

- **等待机制不当**：未正确等待元素/接口/异步操作完成，导致偶发找不到元素或数据未就绪。
- **数据依赖/污染**：用例间数据未隔离，前置/后置数据未清理。
- **环境不稳定**：网络波动、服务偶发超时、第三方依赖不稳定。
- **定位符不稳定**：元素定位方式易变（如动态class、无唯一ID）。
- **并发执行冲突**：并发用例间资源竞争、数据冲突。
- **外部依赖未Mock**：依赖外部接口、服务、消息等，偶发不可用。
- **硬编码sleep**：sleep时间过短或过长，导致时序问题。
- **资源泄漏**：未关闭连接、文件、会话等，影响后续用例。

---

## 3. 排查步骤

1. **复现与收集信息**
   - 多次重跑用例，确认是否为偶发失败。
   - 收集失败日志、截图、控制台输出、网络请求等信息。

2. **分析失败模式**
   - 失败是否集中在某些用例、某些步骤、某些环境？
   - 失败前后有无共性（如网络慢、数据异常、元素未出现）？

3. **定位根因**
   - 检查等待机制、定位符、数据依赖、外部依赖、并发冲突等。
   - 对比通过与失败时的环境、数据、日志差异。

4. **最小复现用例**
   - 尝试剥离无关步骤，保留最小可复现的代码。
   - 单独运行可疑步骤，观察是否稳定。

5. **团队协作排查**
   - 与开发、运维、测试同事协作，排查环境、依赖、代码等多方面。

---

## 4. 典型案例

- **元素未找到**：页面异步加载，未加等待，偶发找不到元素。
- **接口超时**：依赖接口响应慢，未加重试，偶发超时失败。
- **数据污染**：用例未清理数据，导致下次执行失败。
- **定位符变动**：前端代码变更，class/id变化，导致定位失败。
- **并发冲突**：多个用例同时操作同一资源，导致状态异常。

---

## 5. 修复建议

- 优化等待机制，使用显式等待/条件等待，避免硬编码sleep。
- 用例独立，数据隔离，执行前后清理数据。
- 稳定元素定位，必要时与开发协作加自动化友好属性。
- Mock外部依赖，减少不确定性。
- 日志详细，便于定位问题。
- 定期review和重构用例，淘汰不稳定用例。
- CI中对flaky test自动重跑，统计失败率，及时修复。

---

## 6. 总结

Flaky Test是自动化测试稳定性的最大威胁。科学排查、持续优化、团队协作，是消除flaky test、提升自动化可靠性的关键。 